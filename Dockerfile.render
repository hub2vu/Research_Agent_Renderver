# ============================================================
#  Render Deployment Dockerfile
#  Single container: render_app (MCP + Web) + Agent (background)
# ============================================================

# ---------- Stage 1: Build web frontend ----------
FROM node:20-alpine AS web-builder

WORKDIR /build
COPY web/package*.json ./
RUN npm ci --ignore-scripts || npm install

COPY web/ ./
# Skip TypeScript type-checking; just build with Vite
RUN npx vite build


# ---------- Stage 2: Python runtime ----------
FROM python:3.11-slim

# System deps for PyMuPDF (PDF processing)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libmupdf-dev mupdf-tools \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy Python source
COPY mcp/       /app/mcp/
COPY agent/     /app/agent/
COPY logs/      /app/logs/
COPY render_app.py /app/render_app.py

# Copy data directory (NeurIPS/ICLR embeddings etc., if present)
COPY data/      /app/data/

# Copy built web frontend from stage 1
COPY --from=web-builder /build/dist /app/web/dist

# Install Python deps (MCP + Agent)
COPY requirements/ /app/requirements/
RUN pip install --no-cache-dir \
    -r requirements/mcp.txt \
    -r requirements/agent.txt

# Create runtime data dirs
RUN mkdir -p /data/pdf /data/output/graph

# Environment
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app
ENV PDF_DIR=/data/pdf
ENV OUTPUT_DIR=/data/output
ENV DATA_DIR=/app/data

# Startup script
COPY docker/render-start.sh /usr/local/bin/render-start
RUN chmod +x /usr/local/bin/render-start

EXPOSE 10000

CMD ["/usr/local/bin/render-start"]
