version: "3.8"

services:
  # MCP Server - Tool execution layer
  mcp-server:
    build:
      context: .
      dockerfile: docker/Dockerfile.mcp
    container_name: mcp-server
    volumes:
      - ./pdf:/data/pdf
      - ./output:/data/output
      - ./tests:/app/tests
      - ./data:/app/data
    environment:
      - PDF_DIR=/data/pdf
      - OUTPUT_DIR=/data/output
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PYTHONUNBUFFERED=1
    ports:
      - "8000:8000"
    networks:
      - research-network
    restart: unless-stopped

    # ✅ 중요: 컨테이너 외부(다른 컨테이너)에서 접근 가능하도록 0.0.0.0 바인딩
    # FastAPI app 경로가 다르면 "mcp.server:app" 부분만 너 프로젝트에 맞게 바꿔줘.
    command: ["python", "-m", "uvicorn", "mcp.server:app", "--host", "0.0.0.0", "--port", "8000"]

    # ✅ requests 없이 포트 오픈만 검사 (health endpoint 없어도 됨)
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1',8000)); s.close()",
        ]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  # Agent Client - Reasoning layer
  agent:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: research-agent
    volumes:
      - ./pdf:/data/pdf:ro
      - ./output:/data/output:ro
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - MCP_SERVER_URL=http://mcp-server:8000
      - PYTHONUNBUFFERED=1
    env_file:
      - .env
    networks:
      - research-network
    depends_on:
      mcp-server:
        condition: service_healthy
    ports:
      - "8001:8001"
    # [수정] command가 아니라 entrypoint로 변경하여 실행 방식을 강제 지정합니다.
    entrypoint: ["uvicorn", "agent.server:app", "--host", "0.0.0.0", "--port", "8001"]
    restart: unless-stopped

  # Web UI - Graph visualization
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
    container_name: research-web
    volumes:
      - ./web:/app
      - /app/node_modules
      - ./output:/app/output  # writable for node_colors.json
      - ./data:/app/data:ro   # NeurIPS data
    environment:
      - MCP_SERVER_URL=http://mcp-server:8000
      - NODE_ENV=development
    ports:
      - "3000:3000"
    networks:
      - research-network
    depends_on:
      mcp-server:
        condition: service_healthy
    restart: unless-stopped

networks:
  research-network:
    driver: bridge
